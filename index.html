
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–ªè³‡è‡ªå‹•è¨ˆç®—ç³»çµ± - å°ˆæ¥­åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25rem;
            padding-right: 2rem;
            color: #1e293b !important;
        }
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .sync-active { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        @media print {
            @page { size: A4; margin: 1cm; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            input[type="time"]::-webkit-calendar-picker-indicator { display: none; }
            input[type="time"] { border: none; background: transparent; padding: 0; }
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';

        // --- Configuration ---
        const DEFAULT_SHEET_ID = "172dQb2Dh7KLFbsYzehQR2xr_7AVtsb3gonSCZZCkIYQ";

        // --- Utils ---
        const timeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(Number);
            return (parts[0] || 0) * 60 + (parts[1] || 0);
        };

        const calculateDuration = (start, end) => {
            const startMins = timeToMinutes(start);
            const endMins = timeToMinutes(end);
            return endMins > startMins ? (endMins - startMins) / 60 : 0;
        };

        const getDefaultTimes = (dayOfWeek) => {
            if (dayOfWeek === 2) return { start: '16:00', end: '18:00', skipped: false };
            if (dayOfWeek === 0 || dayOfWeek === 6) return { start: '', end: '', skipped: true };
            // é è¨­ä¸Šç­ 11:30ï¼Œä¸‹ç­ 06:30 PM (18:30)
            return { start: '11:30', end: '18:30', skipped: false };
        };

        const formatDateKey = (year, month, day) => {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        };
        
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        // å¼·åŒ–æ™‚é–“æå–ï¼šè­˜åˆ¥ã€Œä¸‹åˆ/PMã€ä¸¦è‡ªå‹•è½‰æ›ç‚º 24 å°æ™‚åˆ¶ä»¥ç¬¦åˆ HTML Time Input
        const cleanToShortTime = (val) => {
            if (!val) return '';
            const str = val.toString().trim();
            const match = str.match(/(\d{1,2}):(\d{1,2})/);
            if (match) {
                let hh = parseInt(match[1]);
                let mm = parseInt(match[2]);
                
                // å¦‚æœå­—ä¸²åŒ…å«ã€Œä¸‹åˆã€æˆ–ã€ŒPMã€ä¸”å°æ™‚æ•¸å°æ–¼ 12ï¼Œè‡ªå‹•è½‰æ›ç‚º 24 å°æ™‚åˆ¶
                if ((str.includes('ä¸‹åˆ') || str.toUpperCase().includes('PM')) && hh < 12) {
                    hh += 12;
                }
                return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
            }
            return '';
        };

        // æ ¸å¿ƒæ›´æ–°ï¼šæ”¯æ´ 2026/01/28 æˆ– 2026/1/28
        const cleanToDateKey = (val) => {
            if (!val) return null;
            const str = val.toString().trim();
            // åŒ¹é… YYYY/MM/DD, YYYY-MM-DD, YYYY.MM.DD
            const match = str.match(/(\d{4})[./\-](\d{1,2})[./\-](\d{1,2})/);
            if (match) {
                return formatDateKey(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            }
            return null;
        };

        const parseCSV = (text) => {
            if (!text) return { headers: [], data: [] };
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length === 0) return { headers: [], data: [] };

            const splitLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i+1] === '"') {
                            current += '"'; i++;
                        } else inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else current += char;
                }
                result.push(current.trim());
                return result;
            };

            const rawHeaders = splitLine(lines[0]);
            const headers = rawHeaders.map(h => h.replace(/^\ufeff/, "").trim());

            const data = lines.slice(1).map(line => {
                const values = splitLine(line);
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] || "";
                    return obj;
                }, {});
            });

            return { headers, data };
        };

        // --- Components ---
        const DayCell = ({ day, dateKey, dayOfWeek, entry, onUpdate, isWeekend }) => {
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const duration = calculateDuration(entry.start, entry.end);

            return React.createElement('div', {
                className: `min-h-[110px] p-2 border-r border-b transition-colors ${entry.skipped ? 'bg-gray-100/60' : isWeekend ? 'bg-indigo-50/40' : 'bg-white'} hover:bg-slate-50 relative group`
            }, [
                React.createElement('div', { key: 'header', className: "flex justify-between items-start mb-2" }, [
                    React.createElement('div', { key: 'label', className: "flex items-baseline gap-1" }, [
                        React.createElement('span', { key: 'd', className: `text-lg font-bold ${isWeekend ? 'text-red-500' : 'text-indigo-700'}` }, day),
                        React.createElement('span', { key: 'w', className: "text-xs text-gray-500 font-medium" }, `é€±${dayNames[dayOfWeek]}`)
                    ]),
                    React.createElement('div', { key: 'skip', className: "flex items-center gap-1 no-print" }, [
                        React.createElement('input', {
                            type: "checkbox",
                            id: `skip-${dateKey}`,
                            checked: entry.skipped,
                            onChange: (e) => onUpdate(dateKey, { skipped: e.target.checked }),
                            className: "w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                        }),
                        React.createElement('label', { htmlFor: `skip-${dateKey}`, className: "text-[10px] text-gray-400 cursor-pointer" }, "ä¼‘å‡")
                    ])
                ]),
                entry.skipped 
                    ? React.createElement('div', { key: 'v', className: "flex items-center justify-center h-12" }, React.createElement('span', { className: "text-lg font-bold text-gray-400 tracking-widest" }, "ä¼‘å‡"))
                    : React.createElement('div', { key: 'i', className: "space-y-1" }, [
                        ['ä¸Šç­', 'start'], ['ä¸‹ç­', 'end']
                    ].map(([label, key]) => (
                        React.createElement('div', { key, className: "flex items-center gap-1" }, [
                            React.createElement('label', { className: "text-[10px] text-gray-400 w-7 no-print" }, label),
                            React.createElement('input', {
                                type: "time",
                                value: entry[key],
                                onChange: (e) => onUpdate(dateKey, { [key]: e.target.value }),
                                className: "w-full text-xs p-1 border border-transparent group-hover:border-gray-200 rounded focus:ring-1 focus:ring-indigo-300 print:border-none"
                            })
                        ])
                    )))
            ]);
        };

        const SyncModal = ({ isOpen, onClose, onSync, initialConfig }) => {
            if (!isOpen) return null;
            const [sheetId, setSheetId] = useState(initialConfig?.sheetId || DEFAULT_SHEET_ID);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [step, setStep] = useState(1);
            const [tempData, setTempData] = useState(null);
            const [mapping, setMapping] = useState(initialConfig?.mapping || { date: '', start: '', end: '' });

            const handleFetch = async () => {
                setIsLoading(true); setError('');
                try {
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                    const response = await fetch(csvUrl);
                    if (!response.ok) throw new Error('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™ã€‚');
                    const text = await response.text();
                    const parsed = parseCSV(text);
                    if (parsed.headers.length === 0) throw new Error('è©¦ç®—è¡¨å…§å®¹ç‚ºç©ºã€‚');
                    setTempData(parsed);
                    setMapping({
                        date: mapping.date || parsed.headers.find(h => h.includes('æ—¥æœŸ')) || '',
                        start: mapping.start || parsed.headers.find(h => h.includes('ä¸Šç­æ™‚é–“')) || '',
                        end: mapping.end || parsed.headers.find(h => h.includes('ä¸‹ç­æ™‚é–“')) || ''
                    });
                    setStep(2);
                } catch (err) { setError(err.message); }
                finally { setIsLoading(false); }
            };

            return React.createElement('div', { className: "fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" }, [
                React.createElement('div', { className: "bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden" }, [
                    React.createElement('div', { className: "p-6 border-b flex justify-between items-center" }, [
                        React.createElement('h3', { className: "text-lg font-bold text-slate-800" }, "Google Sheets åŒæ­¥ä¸­å¿ƒ"),
                        React.createElement('button', { onClick: onClose }, "âœ•")
                    ]),
                    React.createElement('div', { className: "p-6" }, 
                        step === 1 ? React.createElement('div', { className: "space-y-4" }, [
                            React.createElement('p', { className: "text-sm text-slate-500" }, "è«‹è²¼ä¸Šæ‚¨çš„è©¦ç®—è¡¨ IDï¼š"),
                            React.createElement('input', { type: "text", value: sheetId, onChange: e => setSheetId(e.target.value), className: "w-full border p-3 rounded-xl text-sm outline-none" }),
                            error && React.createElement('p', { className: "text-xs text-red-500" }, error)
                        ]) : React.createElement('div', { className: "space-y-3" }, [
                            React.createElement('p', { className: "text-sm text-slate-500" }, `è®€å–æˆåŠŸ (å…± ${tempData.data.length} ç­†)`),
                            ['æ—¥æœŸæ¬„ä½', 'date'], ['ä¸Šç­æ™‚é–“', 'start'], ['ä¸‹ç­æ™‚é–“', 'end']
                        ].map(m => Array.isArray(m) ? React.createElement('div', { key: m[1] }, [
                            React.createElement('label', { className: "text-[10px] font-bold text-slate-400" }, m[0]),
                            React.createElement('select', { value: mapping[m[1]], onChange: e => setMapping(p => ({ ...p, [m[1]]: e.target.value })), className: "w-full border p-2 rounded-lg text-sm bg-slate-50" }, [
                                React.createElement('option', { value: "" }, "-- é¸æ“‡å°æ‡‰æ¬„ä½ --"),
                                ...tempData.headers.map(h => React.createElement('option', { key: h, value: h }, h))
                            ])
                        ]) : m))
                    ),
                    React.createElement('div', { className: "p-6 bg-slate-50 flex gap-2" }, [
                        step === 1 
                        ? React.createElement('button', { onClick: handleFetch, className: "w-full bg-indigo-600 text-white py-3 rounded-xl font-bold" }, isLoading ? "è®€å–ä¸­..." : "ä¸‹ä¸€æ­¥")
                        : [
                            React.createElement('button', { key: 'b', onClick: () => setStep(1), className: "flex-1 bg-white border py-3 rounded-xl" }, "è¿”å›"),
                            React.createElement('button', { key: 's', onClick: () => { onSync({ sheetId, mapping }, tempData.data); onClose(); }, className: "flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold" }, "ç«‹å³åŒ¯å…¥")
                        ]
                    ])
                ])
            ]);
        };

        const App = () => {
            const currentYear = new Date().getFullYear();
            const [year, setYear] = useState(currentYear);
            const [month, setMonth] = useState(new Date().getMonth());
            const [hourlyRate, setHourlyRate] = useState(196);
            const [calendarData, setCalendarData] = useState({});
            const [syncConfig, setSyncConfig] = useState({ sheetId: DEFAULT_SHEET_ID, mapping: null });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isSyncModalOpen, setIsSyncModalOpen] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('salary-v15-stable');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setCalendarData(parsed.data || {});
                    setHourlyRate(parsed.rate || 196);
                    if (parsed.sync) setSyncConfig(parsed.sync);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('salary-v15-stable', JSON.stringify({ data: calendarData, rate: hourlyRate, sync: syncConfig }));
            }, [calendarData, hourlyRate, syncConfig]);

            const processSync = (config, rows) => {
                const newEntries = { ...calendarData };
                let totalUpdated = 0;
                let currentMonthMatches = 0;
                let debugInfo = [];

                rows.forEach((row, idx) => {
                    const rawDate = row[config.mapping.date];
                    const dateKey = cleanToDateKey(rawDate);
                    
                    if (idx < 3) debugInfo.push(`[${idx+1}] åŸå§‹æ—¥æœŸ: "${rawDate}" -> è½‰æ›å¾Œ: "${dateKey || 'è§£æå¤±æ•—'}"`);

                    if (dateKey) {
                        const start = cleanToShortTime(row[config.mapping.start]);
                        const end = cleanToShortTime(row[config.mapping.end]);
                        
                        if (start && end) {
                            newEntries[dateKey] = {
                                dateKey, start, end, skipped: false,
                                duration: calculateDuration(start, end)
                            };
                            totalUpdated++;
                            if (dateKey.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)) {
                                currentMonthMatches++;
                            }
                        }
                    }
                });

                const daysInMonth = getDaysInMonth(year, month);
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateKey = formatDateKey(year, month, d);
                    if (!newEntries[dateKey]) {
                        const dayOfWeek = new Date(year, month, d).getDay();
                        newEntries[dateKey] = { ...getDefaultTimes(dayOfWeek), dateKey, skipped: true, duration: 0 };
                    }
                }

                setSyncConfig(config);
                setCalendarData(newEntries);

                const report = [
                    `âœ… åŒæ­¥å®Œæˆï¼`,
                    `ğŸ“Š é›²ç«¯ç¸½ç­†æ•¸ï¼š${rows.length} ç­†`,
                    `âœ¨ æˆåŠŸåŒ¯å…¥æœ‰æ•ˆå·¥æ™‚ï¼š${totalUpdated} ç­†`,
                    `ğŸ“… ç›®å‰æª¢è¦–æœˆä»½ (${year}/${month+1})ï¼š${currentMonthMatches} ç­†`,
                ];

                if (currentMonthMatches === 0 && rows.length > 0) {
                    report.push(`\nâš ï¸ æ³¨æ„ï¼šç›®å‰æœˆä»½æŸ¥ç„¡åŒ¹é…è³‡æ–™ï¼åµæ¸¬åˆ°çš„å‰å¹¾ç­†æ—¥æœŸå…§å®¹ï¼š`);
                    report.push(...debugInfo);
                    report.push(`\nè«‹æª¢æŸ¥ã€ŒåŒæ­¥è¨­å®šã€ä¸­çš„æ¬„ä½é¸æ“‡æ˜¯å¦æ­£ç¢ºã€‚`);
                }

                alert(report.join('\n'));
            };

            const fastSync = async () => {
                if (!syncConfig.mapping) { setIsSyncModalOpen(true); return; }
                setIsSyncing(true);
                try {
                    const response = await fetch(`https://docs.google.com/spreadsheets/d/${syncConfig.sheetId}/export?format=csv`);
                    const parsed = parseCSV(await response.text());
                    processSync(syncConfig, parsed.data);
                } catch (e) { alert('åŒæ­¥å¤±æ•—ã€‚'); }
                finally { setIsSyncing(false); }
            };

            const totalHours = useMemo(() => {
                let total = 0;
                for (let d = 1; d <= getDaysInMonth(year, month); d++) {
                    const entry = calendarData[formatDateKey(year, month, d)] || getDefaultTimes(new Date(year, month, d).getDay());
                    if (!entry.skipped) total += calculateDuration(entry.start, entry.end);
                }
                return total;
            }, [year, month, calendarData]);

            const daysGrid = useMemo(() => {
                const grid = Array.from({ length: getFirstDayOfMonth(year, month) }, () => null);
                for (let d = 1; d <= getDaysInMonth(year, month); d++) {
                    const dateKey = formatDateKey(year, month, d);
                    const dayOfWeek = new Date(year, month, d).getDay();
                    grid.push({ 
                        day: d, dateKey, dayOfWeek, 
                        entry: calendarData[dateKey] || { ...getDefaultTimes(dayOfWeek), dateKey, duration: 0 } 
                    });
                }
                return grid;
            }, [year, month, calendarData]);

            return React.createElement('div', { className: "max-w-6xl mx-auto p-4 md:p-8 min-h-screen" }, [
                React.createElement('header', { key: 'h', className: "mb-8 flex justify-between items-end" }, [
                    React.createElement('div', null, [
                        React.createElement('h1', { className: "text-3xl font-black text-slate-800" }, "è–ªè³‡è‡ªå‹•è¨ˆç®—ç³»çµ±"),
                        React.createElement('p', { className: "text-slate-500" }, "å°ˆæ¥­åŒæ­¥ï¼šæ”¯æ´ 2026/01/28 æ ¼å¼æ¯”å°")
                    ]),
                    React.createElement('div', { className: "flex gap-4 no-print" }, [
                        React.createElement('button', { onClick: fastSync, className: `p-3 bg-white border rounded-2xl ${isSyncing ? 'sync-active' : ''}` }, "ğŸ”„"),
                        React.createElement('select', { value: year, onChange: e => setYear(Number(e.target.value)), className: "border p-2 rounded-xl" }, Array.from({length:5}, (_,i)=>2024+i).map(y => React.createElement('option',{key:y, value:y},`${y} å¹´`))),
                        React.createElement('select', { value: month, onChange: e => setMonth(Number(e.target.value)), className: "border p-2 rounded-xl" }, Array.from({length:12}, (_,i)=>i).map(m => React.createElement('option',{key:m, value:m},`${m+1} æœˆ`)))
                    ])
                ]),
                React.createElement('main', { key: 'm', className: "bg-white rounded-3xl border overflow-hidden grid grid-cols-7" }, [
                    ...['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => React.createElement('div', { key: d, className: "py-3 text-center text-[10px] font-black bg-slate-50 text-slate-400" }, d)),
                    ...daysGrid.map((item, i) => !item ? React.createElement('div', { key: `e-${i}`, className: "bg-slate-50 border-r border-b" }) :
                        React.createElement(DayCell, { key: item.dateKey, ...item, onUpdate: (key, upd) => setCalendarData(p => ({...p, [key]: {...(p[key]||{...getDefaultTimes(new Date(key).getDay()), dateKey:key}), ...upd}})) , isWeekend: item.dayOfWeek === 0 || item.dayOfWeek === 6 }))
                ]),
                React.createElement('div', { key: 's', className: "mt-8 bg-white border rounded-3xl p-8" }, [
                    React.createElement('div', { className: "flex justify-between items-center mb-8 border-b pb-6" }, [
                        React.createElement('h2', { className: "text-2xl font-black" }, "è–ªè³‡çµç®—å ±å‘Š"),
                        React.createElement('div', { className: "flex gap-2" }, [
                            React.createElement('button', { onClick: () => setIsSyncModalOpen(true), className: "px-4 py-2 bg-emerald-600 text-white rounded-xl" }, "åŒæ­¥è¨­å®š"),
                            React.createElement('button', { onClick: () => window.print(), className: "px-4 py-2 bg-slate-900 text-white rounded-xl" }, "åˆ—å°å ±è¡¨")
                        ])
                    ]),
                    React.createElement('div', { className: "grid grid-cols-3 gap-8" }, [
                        { label: 'æ™‚è–ª', val: React.createElement('input', { type:'number', value:hourlyRate, onChange:e=>setHourlyRate(Number(e.target.value)), className:"w-24 text-indigo-600 font-black outline-none"}) },
                        { label: 'ç¸½è¨ˆå·¥æ™‚', val: `${totalHours.toFixed(2)} Hrs` },
                        { label: 'é è¨ˆç¸½è–ªè³‡', val: `${(totalHours * hourlyRate).toLocaleString()} TWD` }
                    ].map(s => React.createElement('div', { key: s.label, className: "p-6 bg-slate-50 rounded-2xl" }, [
                        React.createElement('label', { className: "text-[10px] text-slate-400 block mb-1" }, s.label),
                        React.createElement('div', { className: "text-2xl font-black" }, s.val)
                    ])))
                ]),
                React.createElement(SyncModal, { isOpen: isSyncModalOpen, onClose: () => setIsSyncModalOpen(false), onSync: processSync, initialConfig: syncConfig })
            ]);
        };

        createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>
