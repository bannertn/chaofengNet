
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–ªè³‡è‡ªå‹•è¨ˆç®—ç³»çµ± - å°ˆæ¥­åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        select {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.1rem;
            padding-right: 2rem;
        }
        .sync-active { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .print-border { border: 2px solid black !important; border-radius: 0 !important; }
            .print-m-0 { margin: 0 !important; }
            @page { margin: 1cm; }
        }
    </style>
    <script type="importmap">
    { "imports": { "react": "https://esm.sh/react@19.0.0", "react-dom/client": "https://esm.sh/react-dom@19.0.0/client" } }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';

        const DEFAULT_SHEET_ID = "172dQb2Dh7KLFbsYzehQR2xr_7AVtsb3gonSCZZCkIYQ";

        // Utils
        const timeToMinutes = (t) => {
            if (!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return (h || 0) * 60 + (m || 0);
        };

        const calculateDuration = (s, e) => {
            const sm = timeToMinutes(s), em = timeToMinutes(e);
            return em > sm ? (em - sm) / 60 : 0;
        };

        const getDefaultTimes = (dayOfWeek) => {
            if (dayOfWeek === 2) return { start: '16:00', end: '18:00', skipped: false };
            if (dayOfWeek === 0 || dayOfWeek === 6) return { start: '', end: '', skipped: true };
            return { start: '11:30', end: '18:30', skipped: false };
        };

        const formatDateKey = (y, m, d) => `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
        const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();

        const cleanToShortTime = (val) => {
            if (!val) return '';
            const str = val.toString().trim();
            const match = str.match(/(\d{1,2}):(\d{1,2})/);
            if (match) {
                let hh = parseInt(match[1]), mm = parseInt(match[2]);
                if ((str.includes('ä¸‹åˆ') || str.toUpperCase().includes('PM')) && hh < 12) hh += 12;
                return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
            }
            return '';
        };

        const cleanToDateKey = (val) => {
            if (!val) return null;
            const str = val.toString().trim();
            const match = str.match(/(\d{4})[./\-](\d{1,2})[./\-](\d{1,2})/);
            if (match) return formatDateKey(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            return null;
        };

        const parseCSV = (text) => {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (!lines.length) return { headers: [], data: [] };
            const split = (l) => {
                const res = []; let cur = '', q = false;
                for (let i = 0; i < l.length; i++) {
                    if (l[i] === '"') q = !q;
                    else if (l[i] === ',' && !q) { res.push(cur.trim()); cur = ''; }
                    else cur += l[i];
                }
                res.push(cur.trim()); return res;
            };
            const headers = split(lines[0]).map(h => h.replace(/^\ufeff/, "").trim());
            return { headers, data: lines.slice(1).map(l => {
                const vals = split(l);
                return headers.reduce((o, h, i) => { o[h] = vals[i] || ""; return o; }, {});
            })};
        };

        // Components
        const DayCell = ({ day, dateKey, dayOfWeek, entry, onUpdate, isWeekend }) => {
            return React.createElement('div', { className: `min-h-[110px] p-2 border-r border-b transition-colors ${entry.skipped ? 'bg-gray-100/60' : isWeekend ? 'bg-indigo-50/40' : 'bg-white'} hover:bg-slate-50 relative group` }, [
                React.createElement('div', { key: 'h', className: "flex justify-between items-start mb-2" }, [
                    React.createElement('div', { key: 'l', className: "flex items-baseline gap-1" }, [
                        React.createElement('span', { className: `text-lg font-bold ${isWeekend ? 'text-red-500' : 'text-indigo-700'}` }, day),
                        React.createElement('span', { className: "text-[10px] text-gray-500 font-medium" }, `é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dayOfWeek]}`)
                    ]),
                    React.createElement('input', { key: 's', type: "checkbox", checked: entry.skipped, onChange: (e) => onUpdate(dateKey, { skipped: e.target.checked }), className: "w-4 h-4 no-print cursor-pointer" })
                ]),
                entry.skipped ? React.createElement('div', { key: 'v', className: "flex items-center justify-center h-12 text-gray-400 font-bold tracking-widest" }, "ä¼‘å‡") :
                React.createElement('div', { key: 'i', className: "space-y-1.5" }, [
                    ['èµ· (ä¸Šç­)', 'start'], ['è¿„ (ä¸‹ç­)', 'end']
                ].map(([l, k]) => React.createElement('div', { key: k, className: "flex items-center gap-1" }, [
                    React.createElement('label', { className: "text-[9px] text-gray-400 w-9 no-print" }, l),
                    React.createElement('input', { type: "time", value: entry[k], onChange: (e) => onUpdate(dateKey, { [k]: e.target.value }), className: "w-full text-xs p-1 border border-transparent group-hover:border-gray-200 rounded focus:ring-1 focus:ring-indigo-300 outline-none print:border-none" })
                ])))
            ]);
        };

        const App = () => {
            const [year, setYear] = useState(2026);
            const [month, setMonth] = useState(0); // 0 = 1æœˆ
            const [hourlyRate, setHourlyRate] = useState(196);
            const [calendarData, setCalendarData] = useState({});
            const [syncConfig, setSyncConfig] = useState({ sheetId: DEFAULT_SHEET_ID, mapping: null });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('salary-v17-final');
                if (saved) {
                    const p = JSON.parse(saved);
                    setCalendarData(p.data || {});
                    setHourlyRate(p.rate || 196);
                    if (p.sync) setSyncConfig(p.sync);
                }
            }, []);

            useEffect(() => { 
                localStorage.setItem('salary-v17-final', JSON.stringify({ data: calendarData, rate: hourlyRate, sync: syncConfig })); 
            }, [calendarData, hourlyRate, syncConfig]);

            const processSync = (config, rows) => {
                const newEntries = { ...calendarData };
                let totalUpdated = 0, currentMonthMatches = 0;
                let debug = [];

                rows.forEach((row, i) => {
                    const dateKey = cleanToDateKey(row[config.mapping.date]);
                    if (dateKey) {
                        const sTime = cleanToShortTime(row[config.mapping.start]);
                        const eTime = cleanToShortTime(row[config.mapping.end]);
                        const def = getDefaultTimes(new Date(dateKey).getDay());
                        
                        newEntries[dateKey] = {
                            dateKey,
                            start: sTime || def.start || '11:30',
                            end: eTime || def.end || '18:30',
                            skipped: false
                        };
                        totalUpdated++;
                        
                        // æª¢æŸ¥æ˜¯å¦ç¬¦åˆç›®å‰é¡¯ç¤ºçš„å¹´æœˆ
                        const targetPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
                        if (dateKey.startsWith(targetPrefix)) {
                            currentMonthMatches++;
                        }
                        
                        if (i < 3) debug.push(`${dateKey}: ${sTime || 'é è¨­'} ~ ${eTime || 'é è¨­'}`);
                    }
                });

                // è£œé½Šç›®å‰æœˆä»½çš„å…¶ä»–å¤©ç©ºç™½è™•ç‚ºé è¨­/ä¼‘å‡
                const days = getDaysInMonth(year, month);
                for (let d = 1; d <= days; d++) {
                    const key = formatDateKey(year, month, d);
                    if (!newEntries[key]) {
                        const def = getDefaultTimes(new Date(year, month, d).getDay());
                        newEntries[key] = { ...def, dateKey: key };
                    }
                }

                setSyncConfig(config);
                setCalendarData(newEntries);
                alert(`âœ… åŒæ­¥å®Œæˆï¼\n\nğŸ“Š ç¸½åŒ¯å…¥ç­†æ•¸ï¼š${totalUpdated} ç­†\nğŸ“… ç›®å‰æœˆä»½ (${year}/${month+1}) æˆåŠŸå°ä½ï¼š${currentMonthMatches} ç­†\n\næª¢æŸ¥é è¦½ï¼š\n${debug.join('\n')}`);
            };

            const fastSync = async () => {
                if (!syncConfig.mapping) { setIsModalOpen(true); return; }
                setIsSyncing(true);
                try {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${syncConfig.sheetId}/export?format=csv`);
                    const csv = parseCSV(await res.text());
                    processSync(syncConfig, csv.data);
                } catch (e) { alert('åŒæ­¥å¤±æ•—'); } finally { setIsSyncing(false); }
            };

            const totalHours = useMemo(() => {
                let total = 0;
                for (let d = 1; d <= getDaysInMonth(year, month); d++) {
                    const key = formatDateKey(year, month, d);
                    const e = calendarData[key] || getDefaultTimes(new Date(year, month, d).getDay());
                    if (!e.skipped) total += calculateDuration(e.start, e.end);
                }
                return total;
            }, [year, month, calendarData]);

            const grid = useMemo(() => {
                const res = Array.from({ length: getFirstDayOfMonth(year, month) }, () => null);
                for (let d = 1; d <= getDaysInMonth(year, month); d++) {
                    const key = formatDateKey(year, month, d);
                    res.push({ 
                        day: d, dateKey: key, 
                        dayOfWeek: new Date(year, month, d).getDay(), 
                        entry: calendarData[key] || { ...getDefaultTimes(new Date(year, month, d).getDay()), dateKey: key } 
                    });
                }
                return res;
            }, [year, month, calendarData]);

            return React.createElement('div', { className: "max-w-6xl mx-auto p-4 md:p-8 min-h-screen" }, [
                // Header
                React.createElement('header', { key: 'h', className: "mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6" }, [
                    React.createElement('div', null, [
                        React.createElement('h1', { className: "text-3xl font-black text-slate-800 flex items-center gap-3" }, [
                            "è–ªè³‡è‡ªå‹•è¨ˆç®—ç³»çµ±",
                            syncConfig.mapping && React.createElement('span', { className: "px-2 py-1 bg-emerald-100 text-emerald-600 text-[10px] rounded-md font-bold" }, "é›²ç«¯é€£å‹•ä¸­")
                        ]),
                        React.createElement('p', { className: "text-slate-500" }, `å°ˆæ¥­å°ä½ï¼š11:30 ä¸Šç­ / 06:30 PM ä¸‹ç­`)
                    ]),
                    React.createElement('div', { className: "flex items-center gap-3 no-print" }, [
                        React.createElement('button', { onClick: fastSync, className: `p-3 bg-white border rounded-xl shadow-sm hover:shadow-md transition-all ${isSyncing ? 'sync-active' : ''}` }, "ğŸ”„ å¿«é€ŸåŒæ­¥"),
                        React.createElement('div', { className: "flex bg-white p-1 rounded-xl border shadow-sm" }, [
                            React.createElement('select', { value: year, onChange: e => setYear(Number(e.target.value)), className: "bg-transparent px-3 py-1 font-bold outline-none border-r" }, [2025, 2026].map(y => React.createElement('option', { key: y, value: y }, `${y}å¹´`))),
                            React.createElement('select', { value: month, onChange: e => setMonth(Number(e.target.value)), className: "bg-transparent px-3 py-1 font-bold outline-none" }, Array.from({length:12}, (_,i)=>React.createElement('option',{key:i, value:i},`${i+1}æœˆ`)))
                        ])
                    ])
                ]),

                // Calendar Main
                React.createElement('main', { key: 'm', className: "bg-white rounded-3xl border shadow-sm overflow-hidden" }, [
                    React.createElement('div', { className: "grid grid-cols-7 bg-slate-50 border-b" }, ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => React.createElement('div', { key: d, className: "py-3 text-center text-[10px] font-black text-slate-400" }, d))),
                    React.createElement('div', { className: "grid grid-cols-7" }, grid.map((item, i) => !item ? React.createElement('div', { key: i, className: "bg-slate-50 border-r border-b" }) : 
                        React.createElement(DayCell, { key: item.dateKey, ...item, onUpdate: (k, u) => setCalendarData(p => ({...p, [k]: {...(p[k]||item.entry), ...u}})), isWeekend: item.dayOfWeek === 0 || item.dayOfWeek === 6 })))
                ]),

                // Summary Report (æ‚¨è¦æ±‚çš„åœ–ç‰‡åŠŸèƒ½å€)
                React.createElement('div', { key: 'f', className: "mt-8 bg-white border rounded-3xl p-8 shadow-lg print-border print-m-0" }, [
                    React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center mb-10 border-b pb-6 no-print" }, [
                        React.createElement('h2', { className: "text-2xl font-black text-slate-800" }, "è–ªè³‡çµç®—å ±å‘Š"),
                        React.createElement('div', { className: "flex gap-4" }, [
                            React.createElement('button', { onClick: () => setIsModalOpen(true), className: "px-8 py-3 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition-all" }, "åŒæ­¥è¨­å®š"),
                            React.createElement('button', { onClick: () => window.print(), className: "px-8 py-3 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 shadow-lg transition-all" }, "åˆ—å°å ±è¡¨")
                        ])
                    ]),
                    
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6 mb-12" }, [
                        { l: 'æ™‚è–ª (TWD)', v: React.createElement('input', { type: 'number', value: hourlyRate, onChange: e => setHourlyRate(Number(e.target.value)), className: "w-full bg-transparent text-3xl font-black text-indigo-600 focus:outline-none" }), s: 'å…ƒ / å°æ™‚' },
                        { l: 'ç¸½å·¥æ™‚', v: totalHours.toFixed(1), s: 'å°æ™‚ (Hrs)' },
                        { l: 'æœ¬æœˆé è¨ˆè–ªè³‡', v: `$ ${(totalHours * hourlyRate).toLocaleString()}`, s: 'æ–°å°å¹£ (TWD)' }
                    ].map(s => React.createElement('div', { key: s.l, className: "p-6 bg-slate-50 rounded-2xl border border-slate-100" }, [
                        React.createElement('label', { className: "text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block" }, s.l),
                        React.createElement('div', { className: "flex items-baseline gap-2" }, [
                            React.createElement('div', { className: "text-3xl font-black text-slate-800" }, s.v),
                            React.createElement('span', { className: "text-xs font-bold text-slate-400" }, s.s)
                        ])
                    ]))),

                    // Signature Area (åˆ—å°å¿…å‚™)
                    React.createElement('div', { className: "mt-16 grid grid-cols-3 gap-12 pt-10 border-t border-dashed" }, ['å“¡å·¥ç°½å', 'éƒ¨é–€ä¸»ç®¡', 'è²¡å‹™ç¢ºèª'].map(t => React.createElement('div', { key: t, className: "flex flex-col gap-8" }, [
                        React.createElement('span', { className: "text-[10px] font-bold text-slate-400 uppercase tracking-widest" }, t),
                        React.createElement('div', { className: "border-b-2 border-slate-200 h-10" })
                    ])))
                ]),

                // Settings Modal
                isModalOpen && React.createElement('div', { key: 'modal', className: "fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" }, 
                    React.createElement('div', { className: "bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl" }, [
                        React.createElement('h3', { className: "text-xl font-bold mb-6 text-slate-800" }, "âš™ é›²ç«¯åŒæ­¥è¨­å®š"),
                        React.createElement('div', { className: "space-y-4 mb-8" }, [
                            React.createElement('div', null, [
                                React.createElement('label', { className: "text-xs font-bold text-slate-400 mb-1 block" }, "Google è©¦ç®—è¡¨ ID"),
                                React.createElement('input', { value: syncConfig.sheetId, onChange: e => setSyncConfig(p => ({...p, sheetId: e.target.value})), className: "w-full border p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500" })
                            ])
                        ]),
                        React.createElement('div', { className: "flex gap-3" }, [
                            React.createElement('button', { onClick: () => setIsModalOpen(false), className: "flex-1 py-3 border rounded-xl font-bold hover:bg-slate-50" }, "å–æ¶ˆ"),
                            React.createElement('button', { onClick: async () => {
                                try {
                                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${syncConfig.sheetId}/export?format=csv`);
                                    if (!res.ok) throw new Error();
                                    const p = parseCSV(await res.text());
                                    const m = { date: p.headers[0], start: p.headers[1]||'', end: p.headers[2]||'' };
                                    processSync({...syncConfig, mapping: m}, p.data);
                                    setIsModalOpen(false);
                                } catch (e) { alert('æŠ“å–å¤±æ•—ï¼Œè«‹ç¢ºèª ID èˆ‡å…±ç”¨æ¬Šé™'); }
                            }, className: "flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700" }, "å„²å­˜è¨­å®š")
                        ])
                    ])
                )
            ]);
        };

        createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>
